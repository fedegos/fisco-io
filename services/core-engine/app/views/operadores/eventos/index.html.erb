<% content_for :title, "Eventos - Operadores - Fisco.io" %>

<div class="page-container">
  <header class="page-header">
    <h1 class="page-title">Secuencia de eventos</h1>
    <p class="page-subtitle">Almacén de eventos (solo lectura). Filtros por tipo, agregado y rango.</p>
  </header>

  <%= form_with url: operadores_eventos_path, method: :get, local: true, class: "filters-bar" do |f| %>
    <label>
      Tipo de evento
      <select name="event_type" aria-label="Filtrar por tipo de evento">
        <option value="">— Todos —</option>
        <% @event_types.each do |et| %>
          <option value="<%= et %>" <%= "selected" if params[:event_type] == et %>><%= et %></option>
        <% end %>
      </select>
    </label>
    <label>
      Tipo de agregado
      <select name="aggregate_type" aria-label="Filtrar por tipo de agregado">
        <option value="">— Todos —</option>
        <% @aggregate_types.each do |at| %>
          <option value="<%= at %>" <%= "selected" if params[:aggregate_type] == at %>><%= at %></option>
        <% end %>
      </select>
    </label>
    <label>
      Desde fecha
      <input type="date" name="from_date" value="<%= params[:from_date] %>" aria-label="Desde fecha" />
    </label>
    <label>
      Hasta fecha
      <input type="date" name="to_date" value="<%= params[:to_date] %>" aria-label="Hasta fecha" />
    </label>
    <label>
      Secuencia desde
      <input type="number" name="from_sequence" value="<%= params[:from_sequence] %>" placeholder="opcional" min="1" aria-label="Secuencia desde" />
    </label>
    <label>
      Secuencia hasta
      <input type="number" name="to_sequence" value="<%= params[:to_sequence] %>" placeholder="opcional" min="1" aria-label="Secuencia hasta" />
    </label>
    <button type="submit">Filtrar</button>
  <% end %>

  <div class="card-grid" role="list">
    <% if @eventos.any? %>
      <% @eventos.each do |ev| %>
        <article class="card card--event" role="listitem">
          <div class="meta-row">
            <span class="badge"><%= ev.event_type %></span>
            <span class="badge badge--muted"><%= ev.aggregate_type %></span>
            <span class="badge badge--muted">v<%= ev.event_version %> · #<%= ev.sequence_number %></span>
          </div>
          <p class="meta-line text-small text-muted">
            <code class="code--xs"><%= ev.aggregate_id %></code>
          </p>
          <p class="text-tiny text-muted">
            <%= l(ev.created_at, format: :long) %>
          </p>
          <details class="details-block">
            <summary>Ver datos (JSON)</summary>
            <pre><%= JSON.pretty_generate(ev.data || {}) %></pre>
          </details>
        </article>
      <% end %>
    <% else %>
      <p class="empty-state">No hay eventos que coincidan con los filtros.</p>
    <% end %>
  </div>
</div>
