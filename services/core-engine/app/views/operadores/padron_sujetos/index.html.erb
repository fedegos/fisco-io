<% content_for :title, "Padrón de sujetos - Operadores - Fisco.io" %>

<div class="page-container" data-controller="cesar-modal">
  <header class="page-header">
    <p class="page-subtitle"><%= link_to "Operadores", operadores_root_path %> → Padrones</p>
    <h1 class="page-title">Padrón de sujetos</h1>
    <p class="page-subtitle">Listado, exportación e importación idempotente por UUID (ID de sujeto).</p>
  </header>

  <p class="page-actions">
    <%= link_to "Empadronar", operadores_new_padron_sujeto_path, class: "btn btn--primary" %>
  </p>

  <div class="filters-bar">
    <%= form_with url: operadores_padron_sujetos_path, method: :get, local: true do |f| %>
      <%= f.text_field :q, value: params[:q], placeholder: "Buscar por nombre o CUIT / número fiscal" %>
      <%= f.submit "Filtrar" %>
    <% end %>
  </div>

  <div class="card card--spaced">
    <h2 class="card__title">Exportar / Importar</h2>
    <p class="card__description">Exportar: archivo JSON con ID de sujeto (UUID) y atributos. Importar: idempotente por ID de sujeto (existe → omitir; no existe → crear).</p>
    <p class="card__description">
      <%= link_to "Descargar JSON", operadores_padron_sujetos_export_path(q: params[:q]), class: "app-nav__link" %>
    </p>
    <%= form_with url: operadores_padron_sujetos_import_path, method: :post, local: true, multipart: true do |f| %>
      <%= f.file_field :file, accept: "application/json" %>
      <%= f.submit "Importar JSON" %>
    <% end %>
  </div>

  <div class="table-wrapper">
    <table class="table" role="grid" aria-label="Padrón de sujetos">
      <thead>
        <tr>
          <th scope="col">ID sujeto (UUID)</th>
          <th scope="col">CUIT / N.º fiscal</th>
          <th scope="col">Razón social</th>
          <th scope="col">Nombre de fantasía</th>
          <th scope="col">Estado</th>
          <th scope="col" class="actions-col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% if @sujetos.any? %>
          <% @sujetos.each do |s| %>
            <tr>
              <td><code class="code--small"><%= s.subject_id %></code></td>
              <td class="cell-tax-id"><%= s.tax_id %></td>
              <td><%= s.legal_name %></td>
              <td><%= s.trade_name %></td>
              <td><span class="badge badge--muted"><%= s.status == "active" ? "Activo" : (s.status == "inactive" ? "Inactivo" : s.status) %></span></td>
              <td class="actions-cell">
                <%= link_to "Ver", operadores_padron_sujeto_path(s.subject_id), class: "btn btn--secondary btn--sm" %>
                <details class="actions-dropdown" data-controller="dropdown">
                  <summary class="btn btn--secondary btn--sm" aria-haspopup="listbox">Acciones</summary>
                  <ul class="actions-dropdown__menu" role="menu" data-dropdown-target="menu">
                    <li><%= link_to "Datos de contacto", operadores_edit_padron_sujeto_path(s.subject_id), role: "menuitem", class: "actions-dropdown__link" %></li>
                    <li><%= link_to "Mudar domicilio", operadores_domicilio_padron_sujeto_path(s.subject_id), role: "menuitem", class: "actions-dropdown__link" %></li>
                    <li><%= link_to "Corregir (fuerza mayor)", operadores_corregir_fuerza_mayor_padron_sujeto_path(s.subject_id), role: "menuitem", class: "actions-dropdown__link" %></li>
                    <% if s.status == "active" %>
                      <li>
                        <button type="button" class="actions-dropdown__link" data-action="click->cesar-modal#open" data-url="<%= operadores_cesar_padron_sujeto_path(s.subject_id) %>" data-subject-name="<%= s.legal_name %>">Cesar</button>
                      </li>
                    <% end %>
                  </ul>
                </details>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="6" class="empty-state">Sin sujetos.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <% if @total_count && @total_count > 0 %>
    <%= render "shared/pagination", page: @page, per_page: @per_page, total_count: @total_count %>
  <% end %>

  <%= render "cesar_modal", cesar_url: "", subject_name: "" %>
</div>
