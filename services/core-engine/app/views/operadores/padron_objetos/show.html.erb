<% content_for :title, "Objeto #{@obligacion.display_id} - Operadores - Fisco.io" %>
<div class="page-container" data-controller="snapshot-modal">
  <header class="page-header">
    <p class="page-subtitle"><%= link_to "Padrón de objetos", operadores_padron_objetos_path %> → Detalle</p>
    <h1 class="page-title">Objeto <%= @obligacion.display_id %></h1>
    <p class="page-subtitle">
      <span class="badge badge--muted"><%= @obligacion.tax_type %></span>
      <% if @obligacion.respond_to?(:status) && @obligacion.status.present? %>
        <span class="badge <%= @obligacion.status == 'closed' ? 'badge--muted' : 'badge--success' %>"><%= @obligacion.status == "closed" ? "Cerrada" : "Abierta" %></span>
      <% end %>
      <span class="id-internal">ID: <%= @obligacion.obligation_id %></span>
    </p>
  </header>

  <div class="page-actions page-actions--wrap">
    <%= link_to "Editar", operadores_edit_padron_objeto_path(@obligacion.obligation_id), class: "btn btn--secondary" %>
    <%= link_to "Cuenta corriente", operadores_obligacion_path(@obligacion.obligation_id), class: "btn btn--secondary" %>
    <%= link_to "Corregir (fuerza mayor)", operadores_corregir_fuerza_mayor_padron_objeto_path(@obligacion.obligation_id), class: "btn btn--secondary" %>
    <% if !@obligacion.respond_to?(:status) || @obligacion.status != "closed" %>
      <%= button_to "Cerrar partida", operadores_cerrar_padron_objeto_path(@obligacion.obligation_id), method: :patch, form: { data: { controller: "confirm", confirm: "¿Cerrar esta partida?" } }, class: "btn btn--secondary" %>
    <% end %>
  </div>

  <section class="card card--spaced">
    <h2 class="card__title card__title--sm">Saldo actual</h2>
    <p class="balance-amount"><%= number_to_currency(@obligacion.current_balance) %></p>
  </section>

  <section class="card card--spaced">
    <h2 class="card__title">Revalúos (valuaciones fiscales por período)</h2>
    <p class="card__description">Registra la valuación fiscal vigente por año para el cálculo inmobiliario.</p>
    <%= form_with url: operadores_padron_objeto_valuaciones_path(@obligacion.obligation_id), method: :post, local: true do |f| %>
      <div class="valuacion-form-row form-field">
        <div class="form-field">
          <label for="year" class="form-field__label">Año</label>
          <input type="number" name="year" id="year" min="2001" max="2100" value="<%= Date.current.year %>" class="form-input form-input--narrow" required />
        </div>
        <div class="form-field">
          <label for="value" class="form-field__label">Valor</label>
          <input type="number" name="value" id="value" min="0" step="0.01" class="form-input form-input--number" required />
        </div>
        <div class="form-field">
          <label for="operator_observations" class="form-field__label">Observaciones (opcional)</label>
          <input type="text" name="operator_observations" id="operator_observations" class="form-input" placeholder="Ej. Revalúo oficial" />
        </div>
        <div class="form-field">
          <%= f.submit "Registrar revalúo", class: "btn btn--primary" %>
        </div>
      </div>
    <% end %>
    <div class="table-wrapper valuacion-table">
      <table class="table" role="grid" aria-label="Valuaciones por año">
        <thead>
          <tr>
            <th scope="col">Año</th>
            <th scope="col">Valor</th>
          </tr>
        </thead>
        <tbody>
          <% if @valuaciones.any? %>
            <% @valuaciones.each do |v| %>
              <tr>
                <td><%= v.year %></td>
                <td><%= number_to_currency(v.value) %></td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="2" class="empty-state">Sin valuaciones cargadas.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </section>

  <% if @eventos.present? %>
  <section class="card card--spaced">
    <h2 class="card__title card__title--sm">Auditoría (eventos)</h2>
    <ul class="event-list">
      <% @eventos.each do |ev| %>
        <li class="event-list__item">
          <span class="badge badge--muted">v<%= ev.event_version %></span>
          <strong><%= ev.event_type %></strong>
          <span class="event-list__meta"><%= ev.created_at.to_fs(:short) %></span>
          <%= link_to "Ver estado hasta aquí", operadores_snapshot_at_padron_objeto_path(@obligacion.obligation_id, up_to_version: ev.event_version), class: "btn btn--secondary btn--sm", data: { turbo_frame: "snapshot_modal" } %>
        </li>
      <% end %>
    </ul>
  </section>
  <% end %>

  <div data-controller="snapshot-modal">
    <%= turbo_frame_tag "snapshot_modal" %>
  </div>
</div>
